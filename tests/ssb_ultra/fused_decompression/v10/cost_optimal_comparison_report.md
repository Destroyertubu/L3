# L3 V10 (COST_OPTIMAL) vs Vertical GPU - Final Comparison Report

**测试日期**: 2024-12-11
**分区策略**: COST_OPTIMAL
**目标分区大小**: 4096
**实际分区数**: 14646 (vs FIXED的29291)

---

## 性能对比汇总

| Query | L3 V10 | Vertical | L3优势 | 加速比 |
|-------|--------|-----------|--------|--------|
| **Q1.1** | **0.371 ms** | 0.544 ms | **32% faster** | 1.47x |
| **Q2.1** | **0.810 ms** | 0.89 ms | **9% faster** | 1.10x |
| **Q3.1** | **1.500 ms** | 2.02 ms | **26% faster** | 1.35x |
| **Q4.1** | **1.396 ms** | 2.73 ms | **49% faster** | 1.95x |

**结论**: 所有4个查询L3 V10都比Vertical快！

---

## 压缩率对比汇总

| Query | L3压缩率 | FL压缩率 | L3优势 | 说明 |
|-------|----------|----------|--------|------|
| **Q1.1** | **3.02x** | 2.00x | **1.51x更小** | quantity(6-bit), discount(4-bit) |
| **Q2.1** | 1.90x | **2.00x** | 5%更大 | partkey需要20-bit |
| **Q3.1** | 1.93x | **2.00x** | 4%更大 | custkey需要19-bit |
| **Q4.1** | 1.99x | **2.00x** | 约相同 | partkey(20-bit)与supplycost(10-bit)抵消 |

---

## 各列详细分析

### SSB列的位宽分布

| 列名 | L3位宽 | FL位宽 | L3压缩率 | 数据范围 |
|------|--------|--------|----------|----------|
| lo_orderdate | 16 | 16 | 1.99x | 日期范围 |
| lo_quantity | **6** | 16 | **5.25x** | 1-50 |
| lo_discount | **4** | 16 | **7.82x** | 0-10 |
| lo_extendedprice | 16 | 16 | 1.99x | 大范围价格 |
| lo_revenue | 16 | 16 | 1.99x | 大范围 |
| lo_supplycost | **10** | 16 | **3.17x** | 中等范围 |
| lo_suppkey | **15** | 16 | **2.12x** | 1-20000 |
| lo_custkey | 19 | 16 | 1.68x | 1-300000 (需要更多bit) |
| lo_partkey | 20 | 16 | 1.59x | 1-800000 (需要更多bit) |

### 压缩效果分类

| 数据类型 | L3位宽 | FL位宽 | L3优势 |
|----------|--------|--------|--------|
| 窄范围枚举 (discount, quantity) | 4-6 | 16 | **2.7-4x更好** |
| 中等范围 (supplycost, suppkey) | 10-15 | 16 | **1.1-1.6x更好** |
| 日期键 | 16 | 16 | 相同 |
| 宽范围键 (custkey, partkey) | 19-20 | 16 | 0.8-0.85x (更差) |

---

## COST_OPTIMAL vs FIXED 策略对比

| 指标 | FIXED | COST_OPTIMAL |
|------|-------|--------------|
| 分区数 | 29291 | **14646** |
| 分区大小 | 固定2048 | 自适应~4096 |
| 元数据开销 | 较大 | **较小 (50%)** |
| 压缩率 | 略好 | 几乎相同 |
| 性能 | 基准 | **几乎相同** |

**结论**: COST_OPTIMAL策略将分区数减少50%，元数据开销显著降低，而性能几乎不变。

---

## 关键发现

### 1. L3在所有查询上都更快

即使在Q2.1、Q3.1、Q4.1上L3的压缩率略逊于Vertical，**L3仍然更快**。这证明：
- 性能优势来自**算法效率**，而非单纯压缩率
- 4x并行度和紧凑元数据设计是关键

### 2. 窄范围数据是L3的强项

| 列 | L3优势 |
|----|--------|
| lo_discount (4-bit) | **3.9x更好压缩** |
| lo_quantity (6-bit) | **2.6x更好压缩** |
| lo_supplycost (10-bit) | **1.6x更好压缩** |

### 3. 宽范围键是L3的弱项

Vertical的固定16-bit编码对于需要>16位的列更高效：
- lo_custkey需要19位 → L3压缩率降低17%
- lo_partkey需要20位 → L3压缩率降低20%

### 4. 元数据开销显著降低

COST_OPTIMAL策略下：
- 分区数: 29291 → 14646 (**50%减少**)
- 每分区元数据: 80-120字节 (V10) vs 290字节 (V7)
- 总元数据: ~1.2MB vs ~8.5MB

---

## V10优化技术汇总

1. **紧凑元数据**: 20字节/列 (bit_base, base_value, local_offset, delta_bits)
2. **4x并行度**: 每L3分区4个block，每个处理1个mini-vector (256值)
3. **模板特化解包**: 0-32位全覆盖，无运行时分支
4. **Warp级归约**: shuffle-based聚合，减少原子操作

---

## 结论

**L3 V10 + COST_OPTIMAL策略**实现了：

✅ **所有查询都比Vertical快** (9%-49%)
✅ **Q1.1压缩率1.51x更好** (窄范围列优势)
✅ **元数据开销减少50%** (COST_OPTIMAL分区)
✅ **无压缩-性能权衡** (压缩略差时性能仍更好)

L3证明：智能自适应压缩 + GPU优化内核 > 固定位宽方案
